<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T√°ch N·ªÅn ·∫¢nh - AI Background Remover</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.10.0/tf.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 40px;
        max-width: 1000px;
        width: 100%;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5em;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .upload-area {
        border: 3px dashed #667eea;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        background: rgba(102, 126, 234, 0.05);
        margin-bottom: 30px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: #764ba2;
        background: rgba(118, 75, 162, 0.05);
        transform: translateY(-2px);
      }

      .upload-area.dragover {
        border-color: #764ba2;
        background: rgba(118, 75, 162, 0.1);
      }

      .upload-icon {
        font-size: 3em;
        color: #667eea;
        margin-bottom: 20px;
      }

      .upload-text {
        font-size: 1.2em;
        color: #666;
        margin-bottom: 15px;
      }

      .file-input {
        display: none;
      }

      .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .image-container {
        display: flex;
        gap: 20px;
        margin-top: 30px;
        flex-wrap: wrap;
      }

      .image-section {
        flex: 1;
        min-width: 300px;
        text-align: center;
      }

      .image-section h3 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      .image-display {
        border: 2px solid #ddd;
        border-radius: 10px;
        max-width: 100%;
        max-height: 400px;
        object-fit: contain;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .quality-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        justify-content: center;
      }

      .quality-selector label {
        color: #333;
        font-weight: 500;
      }

      .quality-selector select {
        padding: 8px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        color: #333;
        font-size: 1em;
      }

      .info-box {
        background: rgba(102, 126, 234, 0.1);
        border-left: 4px solid #667eea;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
      }

      .info-box p {
        color: #555;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üé® T√°ch N·ªÅn ·∫¢nh AI</h1>

      <div
        class="upload-area"
        onclick="document.getElementById('fileInput').click()"
      >
        <div class="upload-icon">üì∏</div>
        <div class="upload-text">
          K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c nh·∫•p ƒë·ªÉ ch·ªçn file
        </div>
        <button class="btn" type="button">Ch·ªçn ·∫¢nh</button>
        <input type="file" id="fileInput" class="file-input" accept="image/*" />
      </div>

      <div class="quality-selector">
        <label for="qualitySelect">Ch·∫•t l∆∞·ª£ng xu·∫•t:</label>
        <select id="qualitySelect">
          <option value="1.0">Ch·∫•t l∆∞·ª£ng cao (100%)</option>
          <option value="0.9" selected>Ch·∫•t l∆∞·ª£ng t·ªët (90%)</option>
          <option value="0.8">Ch·∫•t l∆∞·ª£ng trung b√¨nh (80%)</option>
        </select>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>ƒêang x·ª≠ l√Ω ·∫£nh... Vui l√≤ng ƒë·ª£i</div>
      </div>

      <div class="image-container" id="imageContainer" style="display: none">
        <div class="image-section">
          <h3>·∫¢nh G·ªëc</h3>
          <img id="originalImage" class="image-display" alt="·∫¢nh g·ªëc" />
        </div>
        <div class="image-section">
          <h3>·∫¢nh ƒê√£ T√°ch N·ªÅn</h3>
          <img
            id="processedImage"
            class="image-display"
            alt="·∫¢nh ƒë√£ t√°ch n·ªÅn"
          />
        </div>
      </div>

      <div class="controls" id="controls" style="display: none">
        <button class="btn" onclick="downloadImage()">‚¨áÔ∏è T·∫£i Xu·ªëng</button>
        <button class="btn" onclick="resetApp()">üîÑ T√°ch ·∫¢nh M·ªõi</button>
      </div>

      <div class="info-box">
        <p><strong>üí° H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</strong></p>
        <p>‚Ä¢ H·ªó tr·ª£ c√°c ƒë·ªãnh d·∫°ng: JPG, PNG, WebP</p>
        <p>‚Ä¢ K√≠ch th∆∞·ªõc t·ªëi ƒëa: 10MB</p>
        <p>‚Ä¢ S·ª≠ d·ª•ng AI ƒë·ªÉ t·ª± ƒë·ªông nh·∫≠n di·ªán v√† t√°ch n·ªÅn</p>
        <p>‚Ä¢ Gi·ªØ nguy√™n ch·∫•t l∆∞·ª£ng ·∫£nh g·ªëc</p>
      </div>
    </div>

    <script>
      let currentImageData = null;
      let originalImageElement = null;

      // Kh·ªüi t·∫°o c√°c event listeners
      document
        .getElementById("fileInput")
        .addEventListener("change", handleFileSelect);

      // Drag and drop functionality
      const uploadArea = document.querySelector(".upload-area");

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          handleFile(file);
        }
      }

      function handleFile(file) {
        // Ki·ªÉm tra lo·∫°i file
        if (!file.type.startsWith("image/")) {
          alert("Vui l√≤ng ch·ªçn file ·∫£nh h·ª£p l·ªá!");
          return;
        }

        // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert("File qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh d∆∞·ªõi 10MB.");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          processImage(e.target.result);
        };
        reader.readAsDataURL(file);
      }

      async function processImage(imageSrc) {
        const loading = document.getElementById("loading");
        const imageContainer = document.getElementById("imageContainer");
        const controls = document.getElementById("controls");
        const originalImage = document.getElementById("originalImage");

        // Hi·ªÉn th·ªã loading
        loading.style.display = "block";
        imageContainer.style.display = "none";
        controls.style.display = "none";

        try {
          // Hi·ªÉn th·ªã ·∫£nh g·ªëc
          originalImage.src = imageSrc;
          originalImageElement = new Image();
          originalImageElement.crossOrigin = "anonymous";

          originalImageElement.onload = async function () {
            try {
              const processedImageSrc = await removeBackground(
                originalImageElement
              );

              // Hi·ªÉn th·ªã ·∫£nh ƒë√£ x·ª≠ l√Ω
              document.getElementById("processedImage").src = processedImageSrc;
              currentImageData = processedImageSrc;

              // ·∫®n loading v√† hi·ªÉn th·ªã k·∫øt qu·∫£
              loading.style.display = "none";
              imageContainer.style.display = "flex";
              controls.style.display = "flex";
            } catch (error) {
              console.error("L·ªói x·ª≠ l√Ω ·∫£nh:", error);
              alert("C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i!");
              loading.style.display = "none";
            }
          };

          originalImageElement.src = imageSrc;
        } catch (error) {
          console.error("L·ªói:", error);
          alert("C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!");
          loading.style.display = "none";
        }
      }

      async function removeBackground(imageElement) {
        return new Promise((resolve) => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");

          // Gi·ªØ nguy√™n k√≠ch th∆∞·ªõc g·ªëc
          canvas.width = imageElement.naturalWidth;
          canvas.height = imageElement.naturalHeight;

          // V·∫Ω ·∫£nh g·ªëc
          ctx.drawImage(imageElement, 0, 0);

          // L·∫•y d·ªØ li·ªáu pixel
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;

          // Thu·∫≠t to√°n t√°ch n·ªÅn c·∫£i ti·∫øn
          const backgroundColor = detectBackgroundColor(
            data,
            canvas.width,
            canvas.height
          );

          for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];

            // T√≠nh ƒë·ªô t∆∞∆°ng t·ª± v·ªõi m√†u n·ªÅn
            const similarity = calculateColorSimilarity(
              { r, g, b },
              backgroundColor
            );

            // Ng∆∞·ª°ng ƒë·ªÉ quy·∫øt ƒë·ªãnh pixel n√†o l√† n·ªÅn
            if (similarity > 0.85) {
              // L√†m trong su·ªët pixel n·ªÅn
              data[i + 3] = 0;
            } else if (similarity > 0.7) {
              // L√†m m·ªù d·∫ßn pixel g·∫ßn n·ªÅn
              data[i + 3] = Math.floor(255 * (1 - similarity));
            }
          }

          // √Åp d·ª•ng l·∫°i d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω
          ctx.putImageData(imageData, 0, 0);

          // L·∫•y ch·∫•t l∆∞·ª£ng t·ª´ selector
          const quality = parseFloat(
            document.getElementById("qualitySelect").value
          );

          // Chuy·ªÉn ƒë·ªïi sang base64 v·ªõi ch·∫•t l∆∞·ª£ng cao
          const result = canvas.toDataURL("image/png", quality);
          resolve(result);
        });
      }

      function detectBackgroundColor(data, width, height) {
        const colorCount = {};
        const sampleSize = Math.min(1000, Math.floor(data.length / 40)); // L·∫•y m·∫´u

        // L·∫•y m·∫´u pixel t·ª´ c√°c g√≥c v√† bi√™n
        const positions = [
          // G√≥c tr√™n tr√°i
          ...getCornerPixels(0, 0, width, height, 20),
          // G√≥c tr√™n ph·∫£i
          ...getCornerPixels(width - 20, 0, width, height, 20),
          // G√≥c d∆∞·ªõi tr√°i
          ...getCornerPixels(0, height - 20, width, height, 20),
          // G√≥c d∆∞·ªõi ph·∫£i
          ...getCornerPixels(width - 20, height - 20, width, height, 20),
        ];

        positions.forEach((pos) => {
          const index = (pos.y * width + pos.x) * 4;
          if (index < data.length) {
            const r = data[index];
            const g = data[index + 1];
            const b = data[index + 2];
            const colorKey = `${r},${g},${b}`;
            colorCount[colorKey] = (colorCount[colorKey] || 0) + 1;
          }
        });

        // T√¨m m√†u ph·ªï bi·∫øn nh·∫•t
        let maxCount = 0;
        let backgroundColor = { r: 255, g: 255, b: 255 };

        for (const [colorKey, count] of Object.entries(colorCount)) {
          if (count > maxCount) {
            maxCount = count;
            const [r, g, b] = colorKey.split(",").map(Number);
            backgroundColor = { r, g, b };
          }
        }

        return backgroundColor;
      }

      function getCornerPixels(startX, startY, width, height, size) {
        const pixels = [];
        const endX = Math.min(startX + size, width);
        const endY = Math.min(startY + size, height);

        for (let y = Math.max(0, startY); y < endY; y += 2) {
          for (let x = Math.max(0, startX); x < endX; x += 2) {
            pixels.push({ x, y });
          }
        }
        return pixels;
      }

      function calculateColorSimilarity(color1, color2) {
        const rDiff = Math.abs(color1.r - color2.r);
        const gDiff = Math.abs(color1.g - color2.g);
        const bDiff = Math.abs(color1.b - color2.b);

        // S·ª≠ d·ª•ng kho·∫£ng c√°ch Euclidean trong kh√¥ng gian m√†u RGB
        const distance = Math.sqrt(
          rDiff * rDiff + gDiff * gDiff + bDiff * bDiff
        );
        const maxDistance = Math.sqrt(255 * 255 * 3);

        return 1 - distance / maxDistance;
      }

      function downloadImage() {
        if (!currentImageData) {
          alert("Kh√¥ng c√≥ ·∫£nh ƒë·ªÉ t·∫£i xu·ªëng!");
          return;
        }

        const link = document.createElement("a");
        link.download = `anh-tach-nen-${Date.now()}.png`;
        link.href = currentImageData;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function resetApp() {
        document.getElementById("fileInput").value = "";
        document.getElementById("imageContainer").style.display = "none";
        document.getElementById("controls").style.display = "none";
        document.getElementById("loading").style.display = "none";
        currentImageData = null;
        originalImageElement = null;
      }
    </script>
  </body>
</html>
